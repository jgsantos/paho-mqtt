
(function ExportLibrary(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if(typeof exports==="object"){exports=b()}else{if(typeof a.Paho==="undefined"){a.Paho={}}a.Paho.MQTT=b()}}}})(this,function LibraryFactory(){var a=(function(s){var i="@VERSION@";var l="@BUILDLEVEL@";var p={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14};var n=function(E,D){for(var B in E){if(E.hasOwnProperty(B)){if(D.hasOwnProperty(B)){if(typeof E[B]!==D[B]){throw new Error(v(k.INVALID_TYPE,[typeof E[B],B]))}}else{var C="Unknown property, "+B+". Valid properties are:";for(var A in D){if(D.hasOwnProperty(A)){C=C+" "+A}}throw new Error(C)}}}};var c=function(B,A){return function(){return B.apply(A,arguments)}};var k={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."},BUFFER_FULL:{code:18,text:"AMQJS0018E Message buffer is full, maximum buffer size: {0}."},};var g={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"};var v=function(A,C){var G=A.text;if(C){var F,H;for(var B=0;B<C.length;B++){F="{"+B+"}";H=G.indexOf(F);if(H>0){var E=G.substring(0,H);var D=G.substring(H+F.length);G=E+C[B]+D}}}return G};var f=[0,6,77,81,73,115,100,112,3];var e=[0,4,77,81,84,84,4];var r=function(C,B){this.type=C;for(var A in B){if(B.hasOwnProperty(A)){this[A]=B[A]}}};r.prototype.encode=function(){var I=((this.type&15)<<4);var L=0;var B=[];var E=0;var D;if(this.messageIdentifier!==undefined){L+=2}switch(this.type){case p.CONNECT:switch(this.mqttVersion){case 3:L+=f.length+3;break;case 4:L+=e.length+3;break}L+=d(this.clientId)+2;if(this.willMessage!==undefined){L+=d(this.willMessage.destinationName)+2;D=this.willMessage.payloadBytes;if(!(D instanceof Uint8Array)){D=new Uint8Array(G)}L+=D.byteLength+2}if(this.userName!==undefined){L+=d(this.userName)+2}if(this.password!==undefined){L+=d(this.password)+2}break;case p.SUBSCRIBE:I|=2;for(var H=0;H<this.topics.length;H++){B[H]=d(this.topics[H]);L+=B[H]+2}L+=this.requestedQos.length;break;case p.UNSUBSCRIBE:I|=2;for(var H=0;H<this.topics.length;H++){B[H]=d(this.topics[H]);L+=B[H]+2}break;case p.PUBREL:I|=2;break;case p.PUBLISH:if(this.payloadMessage.duplicate){I|=8}I=I|=(this.payloadMessage.qos<<1);if(this.payloadMessage.retained){I|=1}E=d(this.payloadMessage.destinationName);L+=E+2;var G=this.payloadMessage.payloadBytes;L+=G.byteLength;if(G instanceof ArrayBuffer){G=new Uint8Array(G)}else{if(!(G instanceof Uint8Array)){G=new Uint8Array(G.buffer)}}break;case p.DISCONNECT:break;default:break}var A=y(L);var K=A.length+1;var C=new ArrayBuffer(L+K);var J=new Uint8Array(C);J[0]=I;J.set(A,1);if(this.type==p.PUBLISH){K=u(this.payloadMessage.destinationName,E,J,K)}else{if(this.type==p.CONNECT){switch(this.mqttVersion){case 3:J.set(f,K);K+=f.length;break;case 4:J.set(e,K);K+=e.length;break}var F=0;if(this.cleanSession){F=2}if(this.willMessage!==undefined){F|=4;F|=(this.willMessage.qos<<3);if(this.willMessage.retained){F|=32}}if(this.userName!==undefined){F|=128}if(this.password!==undefined){F|=64}J[K++]=F;K=z(this.keepAliveInterval,J,K)}}if(this.messageIdentifier!==undefined){K=z(this.messageIdentifier,J,K)}switch(this.type){case p.CONNECT:K=u(this.clientId,d(this.clientId),J,K);if(this.willMessage!==undefined){K=u(this.willMessage.destinationName,d(this.willMessage.destinationName),J,K);K=z(D.byteLength,J,K);J.set(D,K);K+=D.byteLength}if(this.userName!==undefined){K=u(this.userName,d(this.userName),J,K)}if(this.password!==undefined){K=u(this.password,d(this.password),J,K)}break;case p.PUBLISH:J.set(G,K);break;case p.SUBSCRIBE:for(var H=0;H<this.topics.length;H++){K=u(this.topics[H],B[H],J,K);J[K++]=this.requestedQos[H]}break;case p.UNSUBSCRIBE:for(var H=0;H<this.topics.length;H++){K=u(this.topics[H],B[H],J,K)}break;default:}return C};function h(L,I){var G=I;var E=L[I];var H=E>>4;var A=E&=15;I+=1;var J;var K=0;var O=1;do{if(I==L.length){return[null,G]}J=L[I++];K+=((J&127)*O);O*=128}while((J&128)!==0);var C=I+K;if(C>L.length){return[null,G]}var M=new r(H);switch(H){case p.CONNACK:var D=L[I++];if(D&1){M.sessionPresent=true}M.returnCode=L[I++];break;case p.PUBLISH:var N=(A>>1)&3;var F=m(L,I);I+=2;var B=o(L,I,F);I+=F;if(N>0){M.messageIdentifier=m(L,I);I+=2}var P=new Paho.MQTT.Message(L.subarray(I,C));if((A&1)==1){P.retained=true}if((A&8)==8){P.duplicate=true}P.qos=N;P.destinationName=B;M.payloadMessage=P;break;case p.PUBACK:case p.PUBREC:case p.PUBREL:case p.PUBCOMP:case p.UNSUBACK:M.messageIdentifier=m(L,I);break;case p.SUBACK:M.messageIdentifier=m(L,I);I+=2;M.returnCode=L.subarray(I,C);break;default:break}return[M,C]}function z(B,A,C){A[C++]=B>>8;A[C++]=B%256;return C}function u(B,C,A,D){D=z(C,A,D);j(B,A,D);return D+C}function m(A,B){return 256*A[B]+A[B+1]}function y(C){var A=new Array(1);var B=0;do{var D=C%128;C=C>>7;if(C>0){D|=128}A[B++]=D}while((C>0)&&(B<4));return A}function d(C){var B=0;for(var D=0;D<C.length;D++){var A=C.charCodeAt(D);if(A>2047){if(55296<=A&&A<=56319){D++;B++}B+=3}else{if(A>127){B+=2}else{B++}}}return B}function j(C,B,G){var F=G;for(var D=0;D<C.length;D++){var A=C.charCodeAt(D);if(55296<=A&&A<=56319){var E=C.charCodeAt(++D);if(isNaN(E)){throw new Error(v(k.MALFORMED_UNICODE,[A,E]))}A=((A-55296)<<10)+(E-56320)+65536}if(A<=127){B[F++]=A}else{if(A<=2047){B[F++]=A>>6&31|192;B[F++]=A&63|128}else{if(A<=65535){B[F++]=A>>12&15|224;B[F++]=A>>6&63|128;B[F++]=A&63|128}else{B[F++]=A>>18&7|240;B[F++]=A>>12&63|128;B[F++]=A>>6&63|128;B[F++]=A&63|128}}}}return B}function o(H,D,A){var B="";var C;var F=D;while(F<D+A){var J=H[F++];if(J<128){C=J}else{var I=H[F++]-128;if(I<0){throw new Error(v(k.MALFORMED_UTF,[J.toString(16),I.toString(16),""]))}if(J<224){C=64*(J-192)+I}else{var G=H[F++]-128;if(G<0){throw new Error(v(k.MALFORMED_UTF,[J.toString(16),I.toString(16),G.toString(16)]))}if(J<240){C=4096*(J-224)+64*I+G}else{var E=H[F++]-128;if(E<0){throw new Error(v(k.MALFORMED_UTF,[J.toString(16),I.toString(16),G.toString(16),E.toString(16)]))}if(J<248){C=262144*(J-240)+4096*I+64*G+E}else{throw new Error(v(k.MALFORMED_UTF,[J.toString(16),I.toString(16),G.toString(16),E.toString(16)]))}}}}if(C>65535){C-=65536;B+=String.fromCharCode(55296+(C>>10));C=56320+(C&1023)}B+=String.fromCharCode(C)}return B}var t=function(A,F,E){this._client=A;this._window=F;this._keepAliveInterval=E*1000;this.isReset=false;var D=new r(p.PINGREQ).encode();var C=function(G){return function(){return B.apply(G)}};var B=function(){if(!this.isReset){this._client._trace("Pinger.doPing","Timed out");this._client._disconnected(k.PING_TIMEOUT.code,v(k.PING_TIMEOUT))}else{this.isReset=false;this._client._trace("Pinger.doPing","send PINGREQ");this._client.socket.send(D);this.timeout=this._window.setTimeout(C(this),this._keepAliveInterval)}};this.reset=function(){this.isReset=true;this._window.clearTimeout(this.timeout);if(this._keepAliveInterval>0){this.timeout=setTimeout(C(this),this._keepAliveInterval)}};this.cancel=function(){this._window.clearTimeout(this.timeout)}};var x=function(A,E,C,F,B){this._window=E;if(!C){C=30}var D=function(I,G,H){return function(){return I.apply(G,H)}};this.timeout=setTimeout(D(F,A,B),C*1000);this.cancel=function(){this._window.clearTimeout(this.timeout)}};var w=function(E,D,B,F,A){if(!("WebSocket" in s&&s.WebSocket!==null)){throw new Error(v(k.UNSUPPORTED,["WebSocket"]))}if(!("localStorage" in s&&s.localStorage!==null)){throw new Error(v(k.UNSUPPORTED,["localStorage"]))}if(!("ArrayBuffer" in s&&s.ArrayBuffer!==null)){throw new Error(v(k.UNSUPPORTED,["ArrayBuffer"]))}this._trace("Paho.MQTT.Client",E,D,B,F,A);this.host=D;this.port=B;this.path=F;this.uri=E;this.clientId=A;this._wsuri=null;this._localKey=D+":"+B+(F!="/mqtt"?":"+F:"")+":"+A+":";this._msg_queue=[];this._buffered_msg_queue=[];this._sentMessages={};this._receivedMessages={};this._notify_msg_sent={};this._message_identifier=1;this._sequence=0;for(var C in localStorage){if(C.indexOf("Sent:"+this._localKey)===0||C.indexOf("Received:"+this._localKey)===0){this.restore(C)}}};w.prototype.host=null;w.prototype.port=null;w.prototype.path=null;w.prototype.uri=null;w.prototype.clientId=null;w.prototype.socket=null;w.prototype.connected=false;w.prototype.maxMessageIdentifier=65536;w.prototype.connectOptions=null;w.prototype.hostIndex=null;w.prototype.onConnected=null;w.prototype.onConnectionLost=null;w.prototype.onMessageDelivered=null;w.prototype.onMessageArrived=null;w.prototype.traceFunction=null;w.prototype._msg_queue=null;w.prototype._buffered_msg_queue=null;w.prototype._connectTimeout=null;w.prototype.sendPinger=null;w.prototype.receivePinger=null;w.prototype._reconnectInterval=1;w.prototype._reconnecting=false;w.prototype._reconnectTimeout=null;w.prototype.disconnectedPublishing=false;w.prototype.disconnectedBufferSize=5000;w.prototype.receiveBuffer=null;w.prototype._traceBuffer=null;w.prototype._MAX_TRACE_ENTRIES=100;w.prototype.connect=function(B){var A=this._traceMask(B,"password");this._trace("Client.connect",A,this.socket,this.connected);if(this.connected){throw new Error(v(k.INVALID_STATE,["already connected"]))}if(this.socket){throw new Error(v(k.INVALID_STATE,["already connected"]))}if(this._reconnecting){this._reconnectTimeout.cancel();this._reconnectTimeout=null;this._reconnecting=false}this.connectOptions=B;this._reconnectInterval=1;this._reconnecting=false;if(B.uris){this.hostIndex=0;this._doConnect(B.uris[0])}else{this._doConnect(this.uri)}};w.prototype.subscribe=function(B,A){this._trace("Client.subscribe",B,A);if(!this.connected){throw new Error(v(k.INVALID_STATE,["not connected"]))}var C=new r(p.SUBSCRIBE);C.topics=[B];if(A.qos!==undefined){C.requestedQos=[A.qos]}else{C.requestedQos=[0]}if(A.onSuccess){C.onSuccess=function(D){A.onSuccess({invocationContext:A.invocationContext,grantedQos:D})}}if(A.onFailure){C.onFailure=function(D){A.onFailure({invocationContext:A.invocationContext,errorCode:D,errorMessage:v(D)})}}if(A.timeout){C.timeOut=new x(this,window,A.timeout,A.onFailure,[{invocationContext:A.invocationContext,errorCode:k.SUBSCRIBE_TIMEOUT.code,errorMessage:v(k.SUBSCRIBE_TIMEOUT)}])}this._requires_ack(C);this._schedule_message(C)};w.prototype.unsubscribe=function(B,A){this._trace("Client.unsubscribe",B,A);if(!this.connected){throw new Error(v(k.INVALID_STATE,["not connected"]))}var C=new r(p.UNSUBSCRIBE);C.topics=[B];if(A.onSuccess){C.callback=function(){A.onSuccess({invocationContext:A.invocationContext})}}if(A.timeout){C.timeOut=new x(this,window,A.timeout,A.onFailure,[{invocationContext:A.invocationContext,errorCode:k.UNSUBSCRIBE_TIMEOUT.code,errorMessage:v(k.UNSUBSCRIBE_TIMEOUT)}])}this._requires_ack(C);this._schedule_message(C)};w.prototype.send=function(B){this._trace("Client.send",B);wireMessage=new r(p.PUBLISH);wireMessage.payloadMessage=B;if(this.connected){if(B.qos>0){this._requires_ack(wireMessage)}else{if(this.onMessageDelivered){this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage)}}this._schedule_message(wireMessage)}else{if(this._reconnecting&&this.disconnectedPublishing){var A=Object.keys(this._sentMessages).length+this._buffered_msg_queue.length;if(A>this.disconnectedBufferSize){throw new Error(v(k.BUFFER_FULL,[this.disconnectedBufferSize]))}else{if(B.qos>0){this._requires_ack(wireMessage)}else{wireMessage.sequence=++this._sequence;this._buffered_msg_queue.push(wireMessage)}}}else{throw new Error(v(k.INVALID_STATE,["not connected"]))}}};w.prototype.disconnect=function(){this._trace("Client.disconnect");if(this._reconnecting){this._reconnectTimeout.cancel();this._reconnectTimeout=null;this._reconnecting=false}if(!this.socket){throw new Error(v(k.INVALID_STATE,["not connecting or connected"]))}wireMessage=new r(p.DISCONNECT);this._notify_msg_sent[wireMessage]=c(this._disconnected,this);this._schedule_message(wireMessage)};w.prototype.getTraceLog=function(){if(this._traceBuffer!==null){this._trace("Client.getTraceLog",new Date());this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var A in this._sentMessages){this._trace("_sentMessages ",A,this._sentMessages[A])}for(var A in this._receivedMessages){this._trace("_receivedMessages ",A,this._receivedMessages[A])}return this._traceBuffer}};w.prototype.startTrace=function(){if(this._traceBuffer===null){this._traceBuffer=[]}this._trace("Client.startTrace",new Date(),i)};w.prototype.stopTrace=function(){delete this._traceBuffer};w.prototype._doConnect=function(B){if(this.connectOptions.useSSL){var A=B.split(":");A[0]="wss";B=A.join(":")}this._wsuri=B;this.connected=false;if(this.connectOptions.mqttVersion<4){this.socket=new WebSocket(B,["mqttv3.1"])}else{this.socket=new WebSocket(B,["mqtt"])}this.socket.binaryType="arraybuffer";this.socket.onopen=c(this._on_socket_open,this);this.socket.onmessage=c(this._on_socket_message,this);this.socket.onerror=c(this._on_socket_error,this);this.socket.onclose=c(this._on_socket_close,this);this.sendPinger=new t(this,window,this.connectOptions.keepAliveInterval);this.receivePinger=new t(this,window,this.connectOptions.keepAliveInterval);if(this._connectTimeout){this._connectTimeout.cancel();this._connectTimeout=null}this._connectTimeout=new x(this,window,this.connectOptions.timeout,this._disconnected,[k.CONNECT_TIMEOUT.code,v(k.CONNECT_TIMEOUT)])};w.prototype._schedule_message=function(A){this._msg_queue.push(A);if(this.connected){this._process_queue()}};w.prototype.store=function(F,E){var B={type:E.type,messageIdentifier:E.messageIdentifier,version:1};switch(E.type){case p.PUBLISH:if(E.pubRecReceived){B.pubRecReceived=true}B.payloadMessage={};var D="";var C=E.payloadMessage.payloadBytes;for(var A=0;A<C.length;A++){if(C[A]<=15){D=D+"0"+C[A].toString(16)}else{D=D+C[A].toString(16)}}B.payloadMessage.payloadHex=D;B.payloadMessage.qos=E.payloadMessage.qos;B.payloadMessage.destinationName=E.payloadMessage.destinationName;if(E.payloadMessage.duplicate){B.payloadMessage.duplicate=true}if(E.payloadMessage.retained){B.payloadMessage.retained=true}if(F.indexOf("Sent:")===0){if(E.sequence===undefined){E.sequence=++this._sequence}B.sequence=E.sequence}break;default:throw Error(v(k.INVALID_STORED_DATA,[key,B]))}localStorage.setItem(F+this._localKey+E.messageIdentifier,JSON.stringify(B))};w.prototype.restore=function(I){var H=localStorage.getItem(I);var G=JSON.parse(H);var J=new r(G.type,G);switch(G.type){case p.PUBLISH:var A=G.payloadMessage.payloadHex;var B=new ArrayBuffer((A.length)/2);var E=new Uint8Array(B);var C=0;while(A.length>=2){var F=parseInt(A.substring(0,2),16);A=A.substring(2,A.length);E[C++]=F}var D=new Paho.MQTT.Message(E);D.qos=G.payloadMessage.qos;D.destinationName=G.payloadMessage.destinationName;if(G.payloadMessage.duplicate){D.duplicate=true}if(G.payloadMessage.retained){D.retained=true}J.payloadMessage=D;break;default:throw Error(v(k.INVALID_STORED_DATA,[I,H]))}if(I.indexOf("Sent:"+this._localKey)===0){J.payloadMessage.duplicate=true;this._sentMessages[J.messageIdentifier]=J}else{if(I.indexOf("Received:"+this._localKey)===0){this._receivedMessages[J.messageIdentifier]=J}}};w.prototype._process_queue=function(){var B=null;var A=this._msg_queue.reverse();while((B=A.pop())){this._socket_send(B);if(this._notify_msg_sent[B]){this._notify_msg_sent[B]();delete this._notify_msg_sent[B]}}};w.prototype._requires_ack=function(B){var A=Object.keys(this._sentMessages).length;if(A>this.maxMessageIdentifier){throw Error("Too many messages:"+A)}while(this._sentMessages[this._message_identifier]!==undefined){this._message_identifier++}B.messageIdentifier=this._message_identifier;this._sentMessages[B.messageIdentifier]=B;if(B.type===p.PUBLISH){this.store("Sent:",B)}if(this._message_identifier===this.maxMessageIdentifier){this._message_identifier=1}};w.prototype._on_socket_open=function(){var A=new r(p.CONNECT,this.connectOptions);A.clientId=this.clientId;this._socket_send(A)};w.prototype._on_socket_message=function(C){this._trace("Client._on_socket_message",C.data);var B=this._deframeMessages(C.data);for(var A=0;A<B.length;A+=1){this._handleMessage(B[A])}};w.prototype._deframeMessages=function(D){var A=new Uint8Array(D);var C=[];if(this.receiveBuffer){var H=new Uint8Array(this.receiveBuffer.length+A.length);H.set(this.receiveBuffer);H.set(A,this.receiveBuffer.length);A=H;delete this.receiveBuffer}try{var B=0;while(B<A.length){var I=h(A,B);var F=I[0];B=I[1];if(F!==null){C.push(F)}else{break}}if(B<A.length){this.receiveBuffer=A.subarray(B)}}catch(E){var G=((E.hasOwnProperty("stack")=="undefined")?E.stack.toString():"No Error Stack Available");this._disconnected(k.INTERNAL_ERROR.code,v(k.INTERNAL_ERROR,[E.message,G]));return}return C};w.prototype._handleMessage=function(L){this._trace("Client._handleMessage",L);try{switch(L.type){case p.CONNACK:this._connectTimeout.cancel();if(this._reconnectTimeout){this._reconnectTimeout.cancel()}if(this.connectOptions.cleanSession){for(var K in this._sentMessages){var J=this._sentMessages[K];localStorage.removeItem("Sent:"+this._localKey+J.messageIdentifier)}this._sentMessages={};for(var K in this._receivedMessages){var A=this._receivedMessages[K];localStorage.removeItem("Received:"+this._localKey+A.messageIdentifier)}this._receivedMessages={}}if(L.returnCode===0){this.connected=true;if(this.connectOptions.uris){this.hostIndex=this.connectOptions.uris.length}}else{this._disconnected(k.CONNACK_RETURNCODE.code,v(k.CONNACK_RETURNCODE,[L.returnCode,g[L.returnCode]]));break}var H=[];for(var B in this._sentMessages){if(this._sentMessages.hasOwnProperty(B)){H.push(this._sentMessages[B])}}if(this._buffered_msg_queue.length>0){var E=null;var M=this._buffered_msg_queue.reverse();while((E=M.pop())){H.push(E);if(this.onMessageDelivered){this._notify_msg_sent[E]=this.onMessageDelivered(E.payloadMessage)}}}var H=H.sort(function(Q,P){return Q.sequence-P.sequence});for(var F=0,G=H.length;F<G;F++){var J=H[F];if(J.type==p.PUBLISH&&J.pubRecReceived){var D=new r(p.PUBREL,{messageIdentifier:J.messageIdentifier});this._schedule_message(D)}else{this._schedule_message(J)}}if(this.connectOptions.onSuccess){this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext})}var C=false;if(this._reconnecting){C=true;this._reconnectInterval=1;this._reconnecting=false}this._connected(C,this._wsuri);this._process_queue();break;case p.PUBLISH:this._receivePublish(L);break;case p.PUBACK:var J=this._sentMessages[L.messageIdentifier];if(J){delete this._sentMessages[L.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+L.messageIdentifier);if(this.onMessageDelivered){this.onMessageDelivered(J.payloadMessage)}}break;case p.PUBREC:var J=this._sentMessages[L.messageIdentifier];if(J){J.pubRecReceived=true;var D=new r(p.PUBREL,{messageIdentifier:L.messageIdentifier});this.store("Sent:",J);this._schedule_message(D)}break;case p.PUBREL:var A=this._receivedMessages[L.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+L.messageIdentifier);if(A){this._receiveMessage(A);delete this._receivedMessages[L.messageIdentifier]}var O=new r(p.PUBCOMP,{messageIdentifier:L.messageIdentifier});this._schedule_message(O);break;case p.PUBCOMP:var J=this._sentMessages[L.messageIdentifier];delete this._sentMessages[L.messageIdentifier];localStorage.removeItem("Sent:"+this._localKey+L.messageIdentifier);if(this.onMessageDelivered){this.onMessageDelivered(J.payloadMessage)}break;case p.SUBACK:var J=this._sentMessages[L.messageIdentifier];if(J){if(J.timeOut){J.timeOut.cancel()}if(L.returnCode[0]===128){if(J.onFailure){J.onFailure(L.returnCode)}}else{if(J.onSuccess){J.onSuccess(L.returnCode)}}delete this._sentMessages[L.messageIdentifier]}break;case p.UNSUBACK:var J=this._sentMessages[L.messageIdentifier];if(J){if(J.timeOut){J.timeOut.cancel()}if(J.callback){J.callback()}delete this._sentMessages[L.messageIdentifier]}break;case p.PINGRESP:this.sendPinger.reset();break;case p.DISCONNECT:this._disconnected(k.INVALID_MQTT_MESSAGE_TYPE.code,v(k.INVALID_MQTT_MESSAGE_TYPE,[L.type]));break;default:this._disconnected(k.INVALID_MQTT_MESSAGE_TYPE.code,v(k.INVALID_MQTT_MESSAGE_TYPE,[L.type]))}}catch(I){var N=((I.hasOwnProperty("stack")=="undefined")?I.stack.toString():"No Error Stack Available");this._disconnected(k.INTERNAL_ERROR.code,v(k.INTERNAL_ERROR,[I.message,N]));return}};w.prototype._on_socket_error=function(A){if(!this._reconnecting){this._disconnected(k.SOCKET_ERROR.code,v(k.SOCKET_ERROR,[A.data]))}};w.prototype._on_socket_close=function(){if(!this._reconnecting){this._disconnected(k.SOCKET_CLOSE.code,v(k.SOCKET_CLOSE))}};w.prototype._socket_send=function(B){if(B.type==1){var A=this._traceMask(B,"password");this._trace("Client._socket_send",A)}else{this._trace("Client._socket_send",B)}this.socket.send(B.encode());this.sendPinger.reset()};w.prototype._receivePublish=function(C){switch(C.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(C);break;case 1:var A=new r(p.PUBACK,{messageIdentifier:C.messageIdentifier});this._schedule_message(A);this._receiveMessage(C);break;case 2:this._receivedMessages[C.messageIdentifier]=C;this.store("Received:",C);var B=new r(p.PUBREC,{messageIdentifier:C.messageIdentifier});this._schedule_message(B);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}};w.prototype._receiveMessage=function(A){if(this.onMessageArrived){this.onMessageArrived(A.payloadMessage)}};w.prototype._connected=function(B,A){if(this.onConnected){this.onConnected(B,A)}};w.prototype._reconnect=function(){this._trace("Client._reconnect");if(!this.connected){this._reconnecting=true;this.sendPinger.cancel();this.receivePinger.cancel();if(this._reconnectInterval<128){this._reconnectInterval=this._reconnectInterval*2}if(this.connectOptions.uris){this.hostIndex=0;this._doConnect(this.connectOptions.uris[0])}else{this._doConnect(this.uri)}}};w.prototype._disconnected=function(B,A){this._trace("Client._disconnected",B,A);if(B!==undefined&&this._reconnecting){this._reconnectTimeout=new x(this,window,this._reconnectInterval,this._reconnect);return}this.sendPinger.cancel();this.receivePinger.cancel();if(this._connectTimeout){this._connectTimeout.cancel();this._connectTimeout=null}this._msg_queue=[];this._buffered_msg_queue=[];this._notify_msg_sent={};if(this.socket){this.socket.onopen=null;this.socket.onmessage=null;this.socket.onerror=null;this.socket.onclose=null;if(this.socket.readyState===1){this.socket.close()}delete this.socket}if(this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1){this.hostIndex++;this._doConnect(this.connectOptions.uris[this.hostIndex])}else{if(B===undefined){B=k.OK.code;A=v(k.OK)}if(this.connected){this.connected=false;if(this.onConnectionLost){this.onConnectionLost({errorCode:B,errorMessage:A,reconnect:this.connectOptions.reconnect,uri:this._wsuri})}if(B!==k.OK.code&&this.connectOptions.reconnect){this._reconnectInterval=1;this._reconnect();return}}else{if(this.connectOptions.mqttVersion===4&&this.connectOptions.mqttVersionExplicit===false){this._trace("Failed to connect V4, dropping back to V3");this.connectOptions.mqttVersion=3;if(this.connectOptions.uris){this.hostIndex=0;this._doConnect(this.connectOptions.uris[0])}else{this._doConnect(this.uri)}}else{if(this.connectOptions.onFailure){this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:B,errorMessage:A})}}}}};w.prototype._trace=function(){if(this.traceFunction){for(var C in arguments){if(typeof arguments[C]!=="undefined"){arguments.splice(C,1,JSON.stringify(arguments[C]))}}var B=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:B})}if(this._traceBuffer!==null){for(var C=0,A=arguments.length;C<A;C++){if(this._traceBuffer.length==this._MAX_TRACE_ENTRIES){this._traceBuffer.shift()}if(C===0){this._traceBuffer.push(arguments[C])}else{if(typeof arguments[C]==="undefined"){this._traceBuffer.push(arguments[C])}else{this._traceBuffer.push("  "+JSON.stringify(arguments[C]))}}}}};w.prototype._traceMask=function(C,B){var D={};for(var A in C){if(C.hasOwnProperty(A)){if(A==B){D[A]="******"}else{D[A]=C[A]}}}return D};var q=function(J,D,K,A){var C;if(typeof J!=="string"){throw new Error(v(k.INVALID_TYPE,[typeof J,"host"]))}if(arguments.length==2){A=D;C=J;var G=C.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(G){J=G[4]||G[2];D=parseInt(G[7]);K=G[8]}else{throw new Error(v(k.INVALID_ARGUMENT,[J,"host"]))}}else{if(arguments.length==3){A=K;K="/mqtt"}if(typeof D!=="number"||D<0){throw new Error(v(k.INVALID_TYPE,[typeof D,"port"]))}if(typeof K!=="string"){throw new Error(v(k.INVALID_TYPE,[typeof K,"path"]))}var B=(J.indexOf(":")!==-1&&J.slice(0,1)!=="["&&J.slice(-1)!=="]");C="ws://"+(B?"["+J+"]":J)+":"+D+K}var H=0;for(var F=0;F<A.length;F++){var I=A.charCodeAt(F);if(55296<=I&&I<=56319){F++}H++}if(typeof A!=="string"||H>65535){throw new Error(v(k.INVALID_ARGUMENT,[A,"clientId"]))}var E=new w(C,J,D,K,A);this._getHost=function(){return J};this._setHost=function(){throw new Error(v(k.UNSUPPORTED_OPERATION))};this._getPort=function(){return D};this._setPort=function(){throw new Error(v(k.UNSUPPORTED_OPERATION))};this._getPath=function(){return K};this._setPath=function(){throw new Error(v(k.UNSUPPORTED_OPERATION))};this._getURI=function(){return C};this._setURI=function(){throw new Error(v(k.UNSUPPORTED_OPERATION))};this._getClientId=function(){return E.clientId};this._setClientId=function(){throw new Error(v(k.UNSUPPORTED_OPERATION))};this._getOnConnected=function(){return E.onConnected};this._setOnConnected=function(L){if(typeof L==="function"){E.onConnected=L}else{throw new Error(v(k.INVALID_TYPE,[typeof L,"onConnected"]))}};this._getDisconnectedPublishing=function(){return E.disconnectedPublishing};this._setDisconnectedPublishing=function(L){E.disconnectedPublishing=L};this._getDisconnectedBufferSize=function(){return E.disconnectedBufferSize};this._setDisconnectedBufferSize=function(L){E.disconnectedBufferSize=L};this._getOnConnectionLost=function(){return E.onConnectionLost};this._setOnConnectionLost=function(L){if(typeof L==="function"){E.onConnectionLost=L}else{throw new Error(v(k.INVALID_TYPE,[typeof L,"onConnectionLost"]))}};this._getOnMessageDelivered=function(){return E.onMessageDelivered};this._setOnMessageDelivered=function(L){if(typeof L==="function"){E.onMessageDelivered=L}else{throw new Error(v(k.INVALID_TYPE,[typeof L,"onMessageDelivered"]))}};this._getOnMessageArrived=function(){return E.onMessageArrived};this._setOnMessageArrived=function(L){if(typeof L==="function"){E.onMessageArrived=L}else{throw new Error(v(k.INVALID_TYPE,[typeof L,"onMessageArrived"]))}};this._getTrace=function(){return E.traceFunction};this._setTrace=function(L){if(typeof L==="function"){E.traceFunction=L}else{throw new Error(v(k.INVALID_TYPE,[typeof L,"onTrace"]))}};this.connect=function(O){O=O||{};n(O,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",reconnect:"boolean",mqttVersion:"number",mqttVersionExplicit:"boolean",uris:"object"});if(O.keepAliveInterval===undefined){O.keepAliveInterval=60}if(O.mqttVersion>4||O.mqttVersion<3){throw new Error(v(k.INVALID_ARGUMENT,[O.mqttVersion,"connectOptions.mqttVersion"]))}if(O.mqttVersion===undefined){O.mqttVersionExplicit=false;O.mqttVersion=4}else{O.mqttVersionExplicit=true}if(O.password!==undefined&&O.userName===undefined){throw new Error(v(k.INVALID_ARGUMENT,[O.password,"connectOptions.password"]))}if(O.willMessage){if(!(O.willMessage instanceof b)){throw new Error(v(k.INVALID_TYPE,[O.willMessage,"connectOptions.willMessage"]))}O.willMessage.stringPayload=null;if(typeof O.willMessage.destinationName==="undefined"){throw new Error(v(k.INVALID_TYPE,[typeof O.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}}if(typeof O.cleanSession==="undefined"){O.cleanSession=true}if(O.hosts){if(!(O.hosts instanceof Array)){throw new Error(v(k.INVALID_ARGUMENT,[O.hosts,"connectOptions.hosts"]))}if(O.hosts.length<1){throw new Error(v(k.INVALID_ARGUMENT,[O.hosts,"connectOptions.hosts"]))}var Q=false;for(var N=0;N<O.hosts.length;N++){if(typeof O.hosts[N]!=="string"){throw new Error(v(k.INVALID_TYPE,[typeof O.hosts[N],"connectOptions.hosts["+N+"]"]))}if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(O.hosts[N])){if(N===0){Q=true}else{if(!Q){throw new Error(v(k.INVALID_ARGUMENT,[O.hosts[N],"connectOptions.hosts["+N+"]"]))}}}else{if(Q){throw new Error(v(k.INVALID_ARGUMENT,[O.hosts[N],"connectOptions.hosts["+N+"]"]))}}}if(!Q){if(!O.ports){throw new Error(v(k.INVALID_ARGUMENT,[O.ports,"connectOptions.ports"]))}if(!(O.ports instanceof Array)){throw new Error(v(k.INVALID_ARGUMENT,[O.ports,"connectOptions.ports"]))}if(O.hosts.length!==O.ports.length){throw new Error(v(k.INVALID_ARGUMENT,[O.ports,"connectOptions.ports"]))}O.uris=[];for(var N=0;N<O.hosts.length;N++){if(typeof O.ports[N]!=="number"||O.ports[N]<0){throw new Error(v(k.INVALID_TYPE,[typeof O.ports[N],"connectOptions.ports["+N+"]"]))}var P=O.hosts[N];var M=O.ports[N];var L=(P.indexOf(":")!==-1);C="ws://"+(L?"["+P+"]":P)+":"+M+K;O.uris.push(C)}}else{O.uris=O.hosts}}E.connect(O)};this.subscribe=function(M,L){if(typeof M!=="string"){throw new Error("Invalid argument:"+M)}L=L||{};n(L,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(L.timeout&&!L.onFailure){throw new Error("subscribeOptions.timeout specified with no onFailure callback.")}if(typeof L.qos!=="undefined"&&!(L.qos===0||L.qos===1||L.qos===2)){throw new Error(v(k.INVALID_ARGUMENT,[L.qos,"subscribeOptions.qos"]))}E.subscribe(M,L)};this.unsubscribe=function(M,L){if(typeof M!=="string"){throw new Error("Invalid argument:"+M)}L=L||{};n(L,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(L.timeout&&!L.onFailure){throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.")}E.unsubscribe(M,L)};this.send=function(M,P,O,L){var N;if(arguments.length===0){throw new Error("Invalid argument.length")}else{if(arguments.length==1){if(!(M instanceof b)&&(typeof M!=="string")){throw new Error("Invalid argument:"+typeof M)}N=M;if(typeof N.destinationName==="undefined"){throw new Error(v(k.INVALID_ARGUMENT,[N.destinationName,"Message.destinationName"]))}E.send(N)}else{N=new b(P);N.destinationName=M;if(arguments.length>=3){N.qos=O}if(arguments.length>=4){N.retained=L}E.send(N)}}};this.publish=function(M,P,O,L){console.log("Publising message to: ",M);var N;if(arguments.length===0){throw new Error("Invalid argument.length")}else{if(arguments.length==1){if(!(M instanceof b)&&(typeof M!=="string")){throw new Error("Invalid argument:"+typeof M)}N=M;if(typeof N.destinationName==="undefined"){throw new Error(v(k.INVALID_ARGUMENT,[N.destinationName,"Message.destinationName"]))}E.send(N)}else{N=new b(P);N.destinationName=M;if(arguments.length>=3){N.qos=O}if(arguments.length>=4){N.retained=L}E.send(N)}}};this.disconnect=function(){E.disconnect()};this.getTraceLog=function(){return E.getTraceLog()};this.startTrace=function(){E.startTrace()};this.stopTrace=function(){E.stopTrace()};this.isConnected=function(){return E.connected}};q.prototype={get hostfunction(){return this._getHost()},set hostfunction(A){this._setHost(A)},get portfunction(){return this._getPort()},set portfunction(A){this._setPort(A)},get pathfunction(){return this._getPath()},set pathfunction(A){this._setPath(A)},get clientIdfunction(){return this._getClientId()},set clientIdfunction(A){this._setClientId(A)},get onConnectedfunction(){return this._getOnConnected()},set onConnectedfunction(A){this._setOnConnected(A)},get disconnectedPublishingfunction(){return this._getDisconnectedPublishing()},set disconnectedPublishingfunction(A){this._setDisconnectedPublishing(A)},get disconnectedBufferSizefunction(){return this._getDisconnectedBufferSize()},set disconnectedBufferSizefunction(A){this._setDisconnectedBufferSize(A)},get onConnectionLostfunction(){return this._getOnConnectionLost()},set onConnectionLostfunction(A){this._setOnConnectionLost(A)},get onMessageDeliveredfunction(){return this._getOnMessageDelivered()},set onMessageDeliveredfunction(A){this._setOnMessageDelivered(A)},get onMessageArrivedfunction(){return this._getOnMessageArrived()},set onMessageArrivedfunction(A){this._setOnMessageArrived(A)},get tracefunction(){return this._getTrace()},set tracefunction(A){this._setTrace(A)}};var b=function(B){var E;if(typeof B==="string"||B instanceof ArrayBuffer||B instanceof Int8Array||B instanceof Uint8Array||B instanceof Int16Array||B instanceof Uint16Array||B instanceof Int32Array||B instanceof Uint32Array||B instanceof Float32Array||B instanceof Float64Array){E=B}else{throw (v(k.INVALID_ARGUMENT,[B,"newPayload"]))}this._getPayloadString=function(){if(typeof E==="string"){return E}else{return o(E,0,E.length)}};this._getPayloadBytes=function(){if(typeof E==="string"){var G=new ArrayBuffer(d(E));var H=new Uint8Array(G);j(E,H,0);return H}else{return E}};var F;this._getDestinationName=function(){return F};this._setDestinationName=function(G){if(typeof G==="string"){F=G}else{throw new Error(v(k.INVALID_ARGUMENT,[G,"newDestinationName"]))}};var C=0;this._getQos=function(){return C};this._setQos=function(G){if(G===0||G===1||G===2){C=G}else{throw new Error("Invalid argument:"+G)}};var A=false;this._getRetained=function(){return A};this._setRetained=function(G){if(typeof G==="boolean"){A=G}else{throw new Error(v(k.INVALID_ARGUMENT,[G,"newRetained"]))}};var D=false;this._getDuplicate=function(){return D};this._setDuplicate=function(G){D=G}};b.prototype={get payloadStringfunction(){return this._getPayloadString()},get payloadBytesfunction(){return this._getPayloadBytes()},get destinationNamefunction(){return this._getDestinationName()},set destinationNamefunction(A){this._setDestinationName(A)},get topicfunction(){return this._getDestinationName()},set topicfunction(A){this._setDestinationName(A)},get qosfunction(){return this._getQos()},set qosfunction(A){this._setQos(A)},get retainedfunction(){return this._getRetained()},set retainedfunction(A){this._setRetained(A)},get duplicatefunction(){return this._getDuplicate()},set duplicatefunction(A){this._setDuplicate(A)}};return{Client:q,Message:b}})(window);return a});